<VirtualHost *:80>
        RewriteEngine on
        ReWriteCond %{SERVER_PORT} !^443$
        RewriteRule ^/(.*) https://%{HTTP_HOST}/$1 [NC,R,L]
</VirtualHost>

<IfModule mod_ssl.c>
    <VirtualHost *:443>
        ServerAdmin aowp.support@accenture.com
        ServerName askme.accenture.com
        #ServerAlias www.askme.accenture.com

        DocumentRoot /opt/sites/askme

        <Directory />
            Options FollowSymLinks
            AllowOverride None
        </Directory>

        <Directory /opt/sites/askme/>
            Options Indexes FollowSymLinks MultiViews
            AllowOverride None
            Require all granted
        </Directory>

        ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
        <Directory "/usr/lib/cgi-bin">
            AllowOverride None
            Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
            Require all granted
        </Directory>

        <Directory /usr/lib/cgi-bin>
            SSLOptions +StdEnvVars
        </Directory>

        LogLevel warn
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/ssl_access.log combined


        SSLEngine on
        SSLCertificateFile /etc/ssl/certs/askme.accenture.com.pem
        SSLCertificateKeyFile /etc/ssl/private/askme_key.pem
        SSLCertificateChainFile	/etc/ssl/certs/askme_cert_chain.cer

        <Location />
            AuthType shibboleth
            ShibRequestSetting requireSession 1
            ShibUseHeaders On
            Require valid-user
            Header set X-UA-Compatible "IE=edge,chrome=1"
        </Location>

        <Location /Shibboleth.sso>
            Satisfy Any
        </Location>

        <Location /api/statistics>
            Satisfy Any
        </Location>

        <FilesMatch "\.(cgi|shtml|phtml|php)$">
            SSLOptions +StdEnvVars
        </FilesMatch>

        BrowserMatch "MSIE [2-6]" nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0
        # MSIE 7 and newer should be able to use keepalive
        BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

        <Proxy *>
            Order deny,allow
            Allow from all
        </Proxy>

        ProxyRequests Off
        ProxyPreserveHost On
        SSLProxyEngine On

        RequestHeader set X-Forwarded-Proto "https"

        # disabling proxy CA check
        SSLProxyVerify optional_no_ca
        SSLProxyCheckPeerCN off
        SSLProxyCheckPeerName off

        # Backend proxy
        ProxyPass /api http://backend:8081/api
        ProxyPassReverse /api http://backend:8081/api

        # SOCKET.io proxy
        ProxyPass /socket.io ws://backend:8081/socket.io
    </VirtualHost>
</IfModule>
